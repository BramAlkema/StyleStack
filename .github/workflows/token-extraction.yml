name: Design Token Extraction

on:
  push:
    paths:
      # Microsoft Office formats
      - 'extract/**/*.pptx'
      - 'extract/**/*.potx'
      - 'extract/**/*.ppsx'
      # OpenOffice/LibreOffice formats
      - 'extract/**/*.odp'
      - 'extract/**/*.otp'
      - 'extract/**/*.ods'
      - 'extract/**/*.ots'
      - 'extract/**/*.odt'
      - 'extract/**/*.ott'
  workflow_dispatch:

jobs:
  extract-tokens:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install lxml PyYAML
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          extract/**/*.pptx
          extract/**/*.potx
          extract/**/*.ppsx
          extract/**/*.odp
          extract/**/*.otp
          extract/**/*.ods
          extract/**/*.ots
          extract/**/*.odt
          extract/**/*.ott
    
    - name: Extract design tokens
      if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ steps.changed-files.outputs.any_changed }}" != "true" ]; then
          # Manual trigger - process all files in extract/ folder
          readarray -t files < <(find extract/ -name "*.pptx" -o -name "*.potx" -o -name "*.ppsx" -o -name "*.odp" -o -name "*.otp" -o -name "*.ods" -o -name "*.ots" -o -name "*.odt" -o -name "*.ott")
        else
          # Push trigger - process changed files
          readarray -t files <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        fi
        
        for file in "${files[@]}"; do
          if [ -z "$file" ]; then continue; fi
          echo "ðŸ” Processing $file"
          
          # Get relative path without extension (support all formats)
          base_name=$(basename "$file")
          base_name="${base_name%.*}"  # Remove any extension
          
          # Get directory path
          dir_path=$(dirname "$file")
          
          # Create output paths
          output_dir="$dir_path/extracted"
          tokens_file="$output_dir/$base_name-tokens.yaml"
          assets_dir="$output_dir/$base_name-assets"
          
          # Create output directory
          mkdir -p "$output_dir"
          
          # Run extraction
          python tools/design_token_extractor.py "$file" \
            --output "$tokens_file" \
            --extract-assets \
            --assets-dir "$assets_dir" \
            --analyze \
            --verbose
          
          echo "âœ… Extracted tokens to $tokens_file"
          if [ -d "$assets_dir" ]; then
            echo "ðŸ“ Assets extracted to $assets_dir"
          fi
        done
    
    - name: Commit extracted tokens
      if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add extract/**/extracted/
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ¤– Extract design tokens from PowerPoint files

          Automatically extracted design tokens and brand assets from:
          ${{ steps.changed-files.outputs.all_changed_files }}

          ðŸ” Generated with StyleStack Design Token Extractor"
          
          git push
        fi