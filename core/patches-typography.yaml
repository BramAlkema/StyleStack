# StyleStack Modern Typography Patches
# Applies advanced typography transforms to OOXML documents
# Based on Open XML PowerTools methodology with modern kerning and OpenType features

$schema: "../schemas/patch.schema.yaml"

metadata:
  name: "Modern Typography Patches"
  version: "1.0.0"
  description: "Advanced typography patches for professional document templates"
  applies_to: ["potx", "dotx", "xltx"]
  requires_tokens: ["typography-modern.yaml", "colors.yaml"]

# ============================================================================
# POWERPOINT (POTX) TYPOGRAPHY PATCHES
# ============================================================================

targets:
  # Theme font definitions - Foundation of typography system
  - file: ppt/theme/theme1.xml
    ns:
      a: "http://schemas.openxmlformats.org/drawingml/2006/main"
    strict: true
    ops:
      # Major font (headings, display text)
      - set:
          xpath: //a:fontScheme/a:majorFont/a:latin/@typeface
          value: "{tokens.fonts.primary.display.family}"
          
      # Minor font (body text)  
      - set:
          xpath: //a:fontScheme/a:minorFont/a:latin/@typeface
          value: "{tokens.fonts.primary.body.family}"
          
      # Complex script fonts (for international support)
      - set:
          xpath: //a:fontScheme/a:majorFont/a:cs/@typeface
          value: "{tokens.fonts.primary.display.family}"
          
      - set:
          xpath: //a:fontScheme/a:minorFont/a:cs/@typeface  
          value: "{tokens.fonts.primary.body.family}"

  # Slide Master 1 - Advanced typography settings
  - file: ppt/slideMasters/slideMaster1.xml
    ns:
      a: "http://schemas.openxmlformats.org/drawingml/2006/main"
      p: "http://schemas.openxmlformats.org/presentationml/2006/main"
    ops:
      # Title placeholder - Modern display typography
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='title']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr/@sz
          value: "{tokens.computed_values.type_scale.display_size_twentieths}"
          
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='title']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr/@kern
          value: "{tokens.computed_values.kerning.display_kern_twentieths}"
          
      # Enable kerning for title
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='title']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr/@kern
          value: "1200"
          description: "Enable kerning (1200 = enabled in OOXML)"
          
      # Content placeholder - Optimized body typography
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='body']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr/@sz
          value: "{tokens.computed_values.type_scale.body_size_twentieths}"
          
      # Line spacing for readability
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='body']/p:txBody/a:lstStyle/a:lvl1pPr/@spcBef
          value: "{tokens.computed_values.spacing.paragraph_before_points}"
          
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='body']/p:txBody/a:lstStyle/a:lvl1pPr/@spcAft
          value: "{tokens.computed_values.spacing.paragraph_after_points}"

      # Insert advanced typography features for OpenType support
      - insert:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='title']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr
          position: last
          xml: |
            <a:latin typeface="{tokens.fonts.primary.display.family}" 
                     pitchFamily="34" charset="0"/>
            <a:hlinkClick tooltip="Modern Typography: {tokens.fonts.primary.display.family} with kerning"/>

  # Layout 1 - Content slide typography  
  - file: ppt/slideLayouts/slideLayout1.xml
    ns:
      a: "http://schemas.openxmlformats.org/drawingml/2006/main"
      p: "http://schemas.openxmlformats.org/presentationml/2006/main"
    ops:
      # Subtitle typography optimization
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='subTitle']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr/@sz
          value: "{tokens.computed_values.type_scale.subtitle_size_twentieths}"
          
      # Enhanced leading for subtitle
      - set:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='subTitle']/p:txBody/a:lstStyle/a:lvl1pPr/@lnSpc
          value: "{tokens.computed_values.spacing.leading.subtitle_percentage}"

# ============================================================================
# WORD (DOTX) TYPOGRAPHY PATCHES  
# ============================================================================

  # Document default styles
  - file: word/styles.xml
    ns:
      w: "http://schemas.openxmlformats.org/wordprocessingml/2006/main"
    strict: true
    ops:
      # Normal style - Foundation typography
      - set:
          xpath: //w:style[@w:styleId='Normal']/w:rPr/w:rFonts/@w:ascii
          value: "{tokens.fonts.primary.body.family}"
          
      - set:
          xpath: //w:style[@w:styleId='Normal']/w:rPr/w:rFonts/@w:hAnsi
          value: "{tokens.fonts.primary.body.family}"
          
      # Font size in half-points (Word standard)
      - set:
          xpath: //w:style[@w:styleId='Normal']/w:rPr/w:sz/@w:val
          value: "{tokens.computed_values.type_scale.base_size_half_points}"
          
      # Line spacing (Word uses 240 twips = 1.0, so 360 = 1.5)
      - set:
          xpath: //w:style[@w:styleId='Normal']/w:pPr/w:spacing/@w:line
          value: "{tokens.computed_values.spacing.leading.body_twips}"
          
      # Paragraph spacing
      - set:
          xpath: //w:style[@w:styleId='Normal']/w:pPr/w:spacing/@w:before
          value: "{tokens.computed_values.spacing.paragraph_before_twips}"
          
      - set:
          xpath: //w:style[@w:styleId='Normal']/w:pPr/w:spacing/@w:after
          value: "{tokens.computed_values.spacing.paragraph_after_twips}"

      # Heading 1 - Display typography
      - set:
          xpath: //w:style[@w:styleId='Heading1']/w:rPr/w:rFonts/@w:ascii
          value: "{tokens.fonts.primary.display.family}"
          
      - set:
          xpath: //w:style[@w:styleId='Heading1']/w:rPr/w:sz/@w:val
          value: "{tokens.computed_values.type_scale.heading1_size_half_points}"
          
      # Bold weight for headings
      - set:
          xpath: //w:style[@w:styleId='Heading1']/w:rPr/w:b/@w:val
          value: "1"
          
      # Advanced kerning for headings
      - set:
          xpath: //w:style[@w:styleId='Heading1']/w:rPr/w:kern/@w:val
          value: "{tokens.computed_values.kerning.heading_kern_half_points}"

      # Heading 2
      - set:
          xpath: //w:style[@w:styleId='Heading2']/w:rPr/w:rFonts/@w:ascii
          value: "{tokens.fonts.primary.display.family}"
          
      - set:
          xpath: //w:style[@w:styleId='Heading2']/w:rPr/w:sz/@w:val
          value: "{tokens.computed_values.type_scale.heading2_size_half_points}"

      # Quote style - Elegant typography
      - set:
          xpath: //w:style[@w:styleId='Quote']/w:rPr/w:i/@w:val
          value: "1"
          
      - set:
          xpath: //w:style[@w:styleId='Quote']/w:rPr/w:sz/@w:val
          value: "{tokens.computed_values.type_scale.quote_size_half_points}"
          
      # Increased tracking for quotes
      - set:
          xpath: //w:style[@w:styleId='Quote']/w:rPr/w:spacing/@w:val
          value: "{tokens.computed_values.spacing.tracking.quote_twips}"

  # Document theme fonts
  - file: word/theme/theme1.xml
    ns:
      a: "http://schemas.openxmlformats.org/drawingml/2006/main"
    ops:
      # Major font (headings)
      - set:
          xpath: //a:fontScheme/a:majorFont/a:latin/@typeface
          value: "{tokens.fonts.primary.display.family}"
          
      # Minor font (body)
      - set:
          xpath: //a:fontScheme/a:minorFont/a:latin/@typeface
          value: "{tokens.fonts.primary.body.family}"

# ============================================================================
# EXCEL (XLTX) TYPOGRAPHY PATCHES
# ============================================================================

  # Workbook styles
  - file: xl/styles.xml
    ns:
      s: "http://schemas.openxmlformats.org/spreadsheetml/2006/main"
    ops:
      # Default cell font
      - set:
          xpath: //s:fonts/s:font[1]/s:name/@val
          value: "{tokens.fonts.primary.body.family}"
          
      # Default font size (Excel uses points directly)
      - set:
          xpath: //s:fonts/s:font[1]/s:sz/@val
          value: "{tokens.computed_values.type_scale.excel_base_size_points}"
          
      # Header font (bold)
      - set:
          xpath: //s:fonts/s:font[2]/s:name/@val
          value: "{tokens.fonts.primary.display.family}"
          
      - set:
          xpath: //s:fonts/s:font[2]/s:sz/@val
          value: "{tokens.computed_values.type_scale.excel_header_size_points}"
          
      # Bold weight for headers
      - set:
          xpath: //s:fonts/s:font[2]/s:b/@val
          value: "1"

  # Workbook theme fonts
  - file: xl/theme/theme1.xml
    ns:
      a: "http://schemas.openxmlformats.org/drawingml/2006/main"
    ops:
      # Major font
      - set:
          xpath: //a:fontScheme/a:majorFont/a:latin/@typeface
          value: "{tokens.fonts.primary.display.family}"
          
      # Minor font  
      - set:
          xpath: //a:fontScheme/a:minorFont/a:latin/@typeface
          value: "{tokens.fonts.primary.body.family}"

# ============================================================================
# ADVANCED OPENTYPE FEATURE PATCHES
# ============================================================================

  # PowerPoint - OpenType features for modern browsers/viewers
  - file: ppt/slideMasters/slideMaster1.xml
    ns:
      a: "http://schemas.openxmlformats.org/drawingml/2006/main"
      p: "http://schemas.openxmlformats.org/presentationml/2006/main"
    ops:
      # Insert OpenType feature settings (experimental)
      - insert:
          xpath: //p:sp[p:nvSpPr/p:nvPr/p:ph/@type='title']/p:txBody/a:lstStyle/a:lvl1pPr/a:defRPr
          position: last
          xml: |
            <a:extLst>
              <a:ext uri="{OpenType-Features}">
                <opentype:features xmlns:opentype="http://schemas.microsoft.com/office/opentype/2014/main">
                  <opentype:feature tag="kern" value="1"/>
                  <opentype:feature tag="liga" value="1"/>
                  <opentype:feature tag="calt" value="1"/>
                </opentype:features>
              </a:ext>
            </a:extLst>

# ============================================================================
# RELATIONSHIP ADDITIONS
# ============================================================================

  # Add relationships for embedded fonts (if needed)
  - relsAdd:
      file: ppt/_rels/presentation.xml.rels
      items:
        - id: rIdFontInter
          type: "http://schemas.microsoft.com/office/2007/relationships/font"
          target: "fonts/Inter-Regular.ttf"
        - id: rIdFontInterBold
          type: "http://schemas.microsoft.com/office/2007/relationships/font"
          target: "fonts/Inter-Bold.ttf"

# ============================================================================
# COMPUTED VALUES FOR TOKENS
# ============================================================================

# These values are computed from the base tokens and OOXML requirements
computed_tokens:
  type_scale:
    # PowerPoint uses twentieths of a point (1pt = 20 units)
    display_size_twentieths: 976     # 48.8pt * 20
    subtitle_size_twentieths: 640    # 32pt * 20  
    body_size_twentieths: 320        # 16pt * 20
    
    # Word uses half-points (1pt = 2 units)
    base_size_half_points: 32        # 16pt * 2
    heading1_size_half_points: 78    # 39pt * 2
    heading2_size_half_points: 62    # 31pt * 2
    quote_size_half_points: 40       # 20pt * 2
    
    # Excel uses points directly
    excel_base_size_points: 11       # Standard Excel size
    excel_header_size_points: 12     # Header size
    
  kerning:
    # PowerPoint kerning in twentieths
    display_kern_twentieths: -32     # -0.08em * 20pt * 20
    
    # Word kerning in half-points
    heading_kern_half_points: 24     # 12pt minimum for kerning
    
  spacing:
    # Line spacing percentages (PowerPoint)
    leading:
      subtitle_percentage: 120       # 120% = 1.2 leading
      
    # Paragraph spacing in points
    paragraph_before_points: 8       # 0.5em at 16pt
    paragraph_after_points: 12       # 0.75em at 16pt
    
    # Word spacing in twips (1/20 point)
    paragraph_before_twips: 160      # 8pt * 20
    paragraph_after_twips: 240       # 12pt * 20
    leading:
      body_twips: 360                # 1.5 * 12pt * 20
      
    # Character tracking in twips
    tracking:
      quote_twips: 20                # +1pt tracking
      
# ============================================================================
# VALIDATION RULES
# ============================================================================

validation:
  required_elements:
    - "ppt/theme/theme1.xml://a:fontScheme/a:majorFont/a:latin"
    - "ppt/theme/theme1.xml://a:fontScheme/a:minorFont/a:latin"
    - "word/styles.xml://w:style[@w:styleId='Normal']/w:rPr/w:rFonts"
    
  typography_checks:
    - name: "font_consistency"
      description: "Ensure consistent font usage across templates"
    - name: "size_hierarchy"  
      description: "Validate typographic scale hierarchy"
    - name: "kerning_values"
      description: "Check kerning values are within reasonable bounds"